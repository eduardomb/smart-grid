(function(o){"use strict";o.fn.grid=function(t){function i(o){return o+"px"}function n(o){for(var t,i,n=o.length;0!==n;)i=Math.floor(Math.random()*n),n-=1,t=o[n],o[n]=o[i],o[i]=t;return o}function s(o,t){if(t[S]+o[S]-1>=L.cols)return!1;for(var i=t[w];t[w]+o[w]>i;i++)for(var n=t[S];t[S]+o[S]>n;n++)if(void 0!==k[i]&&k[i][n]>=0)return!1;return!0}function r(){for(var o=0;k.length>o;o++)for(var t=0;L.cols>t;t++)if(void 0===k[o][t])return[o,t];return[k.length,0]}function e(o,t,i){if(i=n(i),1==t)return[1,1];for(var r=0;i.length>r;r++)if(s(i[r],o))return i[r];return[1,1]}function l(t,n,s){var r=o("<div></div>");r.css({height:"0","border-bottom-color":L.hLineColor,"border-bottom-width":i(L.hLineThickness),"border-bottom-style":"dotted",position:"absolute",width:i((s-n)*(m+C)+m),left:i(n*(m+C)),top:i(g*(z+C)+z+L.hSpacing)}),t.append(r)}function c(o,t){o.css({position:"absolute",display:"inline-block",width:i(t.cols*(m+C)-C),height:i(t.rows*(z+T)-T),left:i(t.pos[S]*(m+C)),top:i(t.pos[w]*(z+T))})}function a(o,t){return void 0!==k[o]&&k[o][t]!=k[o][t+1]}function h(o,t){return k[o][t]!=k[o+1][t]}function f(o,t){for(var i=o.data("rows"),n=o.data("cols"),s=o.data("pos"),r=t+1;s[w]+i>r;r++)for(var e=s[S];s[S]+n>e;e++)k[r][e]=void 0;o.data("rows",t-s[w]+1),c(o,o.data())}var d,u,v,p,g,b,w=0,S=1,L=o.extend({cols:3,hSpacing:10,vSpacing:10,hLineThickness:1,vLineThickness:1,hLineColor:"#ccc",vLineColor:"#ccc",selector:"div",sizes:[[1,1]],startsWith:[],aspectRatio:1,hBox:0},t),x=0,k=[],C=2*L.vSpacing+L.vLineThickness,T=2*L.hSpacing+L.hLineThickness,m=(this.width()-(L.cols-1)*C)/L.cols,z=L.hBox?L.hBox:m*L.aspectRatio,y=o(L.selector,this);if("fixed"==this.css("position"))return o.error("Grid objects can't have position: fixed on CSS."),this;if("static"==this.css("position")&&this.css("position","relative"),!y.length)return this;y.each(function(t){var i,n=r(),s=e(n,y.length-t,L.sizes),l=function(o){return o.join()};s=L.startsWith[t]||s;for(var a in L.classSizes){var h=L.classSizes[a].map(l),f=-1!=h.indexOf(l(s));o(this).hasClass(a)&&!f&&(s=e(n,y.length-t,L.classSizes[a]))}for(i={id:x++,pos:n,rows:s[0],cols:s[1]},t=n[w];n[w]+i.rows>t;t++)for(void 0===k[t]&&(k[t]=[]),p=n[S];n[S]+i.cols>p;p++)k[t][p]=i.id;c(o(this),i),o(this).data(i)});var j,B,M=o(y[y.length-1]),R=M.data("pos"),W=M.data("rows"),G=M.data("cols");if(void 0!==k[R[w]+W])for(v=0;L.cols>v;v++)k[R[w]+W][v]>=0&&(j=o(y[k[R[w]+W][v]]),f(j,R[w]+W-1));for(B=!0,v=R[S]+G;L.cols>v;v++)B&=k[R[w]][v]>=0;if(!B)for(v=R[S]+G;L.cols>v;v++)k[R[w]][v]>=0&&(j=o(y[k[R[w]][v]]),f(j,R[w]-1));for(B=!0,v=R[S]+G;L.cols>v;v++)B&=k[R[w]][v]>=0;if(!B){for(v=R[w];R[w]+W>v;v++)for(p=R[S]+G;L.cols>p;p++)k[v][p]=M.data("id");M.data("cols",L.cols-R[S]),c(M,M.data())}for(k.splice(R[w]+W,k.length-R[w]-W),b=0;L.cols-1>b;b++)for(d=null,u=null,g=0;k.length>g;){for(;a(g++,b);)null===d?(d=g-1,u=g-1):u=g-1;if(null!==d&&null!==u){var O=o("<div></div>");O.css({width:"0","border-left-width":i(L.vLineThickness),"border-left-style":"dotted","border-left-color":L.vLineColor,position:"absolute",height:i((u-d)*(z+T)+z),left:i(b*(m+C)+m+L.vSpacing),top:i(d*(z+T))}),this.append(O),d=null,u=null}}for(g=0;k.length-1>g;g++)for(d=null,u=null,b=0;void 0!==k[g]&&L.cols>b;){for(;h(g,b++);)null===d?d=b-1:a(g,b-2)&&a(g+1,b-2)&&(l(this,d,u),d=b-1),u=b-1;null!==d&&null!==u&&(l(this,d,u),d=null,u=null)}return this.height(k.length*(z+T)),this}})(jQuery);
